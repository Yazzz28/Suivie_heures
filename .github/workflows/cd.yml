name: CD - Déploiement Continu

on:
  workflow_run:
    workflows: ["CI - Intégration Continue"]
    types:
      - completed
    branches: [docker]

jobs:
  download-and-push:
    name: 🐳 Download, Load & Push Docker image
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: 📥 Télécharger l'artifact Docker
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: .

      - name: 🐳 Charger l'image Docker
        run: |
          gunzip -c hourproject_*.tar.gz | docker load

      - name: 🏷️ Taguer l'image Docker
        run: |
          IMAGE_ID=$(docker images --format '{{.Repository}}:{{.Tag}} {{.ID}}' | grep hourproject | awk '{print $2}' | head -n1)
          docker tag $IMAGE_ID ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:${{ github.sha }}

      - name: 🔐 Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: 🐳 Push Docker image
        run: |
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:${{ github.sha }}

  deploy:
    name: 🚀 Déploiement VPS
    needs: download-and-push
    runs-on: ubuntu-latest
    steps:
      - name: 🔑 Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: 🚀 SSH to VPS and deploy
        run: |
          TAG=${{ github.sha }}
          VPS_USER="${{ secrets.VPS_USER }}"
          VPS_HOST="${{ secrets.VPS_HOST }}"
          SSH_KEY="~/.ssh/id_ed25519"
          VPS_PATH="~/hourproject/prod"
          PORT="8080"
          ssh -o StrictHostKeyChecking=no -i $SSH_KEY $VPS_USER@$VPS_HOST << EOF
            mkdir -p $VPS_PATH
            cd $VPS_PATH
            docker stop hourproject-$TAG || true
            docker rm hourproject-$TAG || true
            docker image prune -f
            docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:$TAG
            docker run -d --name hourproject-$TAG --restart unless-stopped -p $PORT:80 -v $VPS_PATH/public:/var/www/public ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:$TAG
            sleep 5
            docker ps | grep hourproject-$TAG
          EOF

      - name: 🏥 Health check
        run: |
          TAG=${{ github.sha }}
          VPS_HOST="${{ secrets.VPS_HOST }}"
          PORT="8080"
          sleep 10
          if curl -f -s --max-time 30 http://$VPS_HOST:$PORT/ > /dev/null; then
            echo "✅ Application accessible et fonctionnelle"
          else
            echo "⚠️ Application potentiellement indisponible, vérifiez manuellement"
            echo "🌐 URL: http://$VPS_HOST:$PORT/"
          fi

  notification:
    name: 📢 Notification de déploiement
    needs: [download-and-push, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: 📋 Générer le rapport de déploiement
        run: |
          TAG=${{ github.sha }}
          echo "📊 RAPPORT DE DÉPLOIEMENT HOURPROJECT"
          echo "======================================"
          echo "🕐 Date: $(date)"
          echo "🌿 Branche: ${{ github.ref_name }}"
          echo "🏷️ Tag: $TAG"
          echo "📝 Commit: ${{ github.sha }}"
          echo "👤 Auteur: ${{ github.actor }}"
          echo "🐳 Image: ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:$TAG"
          echo ""
          if [[ "${{ needs.download-and-push.result }}" == "success" && "${{ needs.deploy.result }}" == "success" ]]; then
            echo "✅ Déploiement réussi"
            echo "🎯 URL Production: http://${{ secrets.VPS_HOST }}:8080/"
          else
            echo "❌ Déploiement échoué"
            echo "🔍 Build: ${{ needs.download-and-push.result }}"
            echo "🔍 Deploy: ${{ needs.deploy.result }}"
            echo "📝 Vérifiez les logs des étapes précédentes"
          fi
