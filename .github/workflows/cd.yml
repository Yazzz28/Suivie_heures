name: CD - DÃ©ploiement Continu

on:
  workflow_run:
    workflows: ["CI - IntÃ©gration Continue"]
    types:
      - completed
    branches: [docker]

jobs:
  download-and-push:
    name: ğŸ³ Download, Load & Push Docker image
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: ğŸ“¥ TÃ©lÃ©charger l'artifact Docker
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: .

      - name: ğŸ³ Charger l'image Docker
        run: |
          gunzip -c hourproject_*.tar.gz | docker load

      - name: ğŸ·ï¸ Taguer l'image Docker
        run: |
          IMAGE_ID=$(docker images --format '{{.Repository}}:{{.Tag}} {{.ID}}' | grep hourproject | awk '{print $2}' | head -n1)
          docker tag $IMAGE_ID ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:${{ github.sha }}

      - name: ğŸ” Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: ğŸ³ Push Docker image
        run: |
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:${{ github.sha }}

  deploy:
    name: ğŸš€ DÃ©ploiement VPS
    needs: download-and-push
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”‘ Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: ğŸš€ SSH to VPS and deploy
        run: |
          TAG=${{ github.sha }}
          VPS_USER="${{ secrets.VPS_USER }}"
          VPS_HOST="${{ secrets.VPS_HOST }}"
          SSH_KEY="~/.ssh/id_ed25519"
          VPS_PATH="~/hourproject/prod"
          PORT="8080"
          ssh -o StrictHostKeyChecking=no -i $SSH_KEY $VPS_USER@$VPS_HOST << EOF
            mkdir -p $VPS_PATH
            cd $VPS_PATH
            docker stop hourproject-$TAG || true
            docker rm hourproject-$TAG || true
            docker image prune -f
            docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:$TAG
            docker run -d --name hourproject-$TAG --restart unless-stopped -p $PORT:80 -v $VPS_PATH/public:/var/www/public ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:$TAG
            sleep 5
            docker ps | grep hourproject-$TAG
          EOF

      - name: ğŸ¥ Health check
        run: |
          TAG=${{ github.sha }}
          VPS_HOST="${{ secrets.VPS_HOST }}"
          PORT="8080"
          sleep 10
          if curl -f -s --max-time 30 http://$VPS_HOST:$PORT/ > /dev/null; then
            echo "âœ… Application accessible et fonctionnelle"
          else
            echo "âš ï¸ Application potentiellement indisponible, vÃ©rifiez manuellement"
            echo "ğŸŒ URL: http://$VPS_HOST:$PORT/"
          fi

  notification:
    name: ğŸ“¢ Notification de dÃ©ploiement
    needs: [download-and-push, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“‹ GÃ©nÃ©rer le rapport de dÃ©ploiement
        run: |
          TAG=${{ github.sha }}
          echo "ğŸ“Š RAPPORT DE DÃ‰PLOIEMENT HOURPROJECT"
          echo "======================================"
          echo "ğŸ• Date: $(date)"
          echo "ğŸŒ¿ Branche: ${{ github.ref_name }}"
          echo "ğŸ·ï¸ Tag: $TAG"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Auteur: ${{ github.actor }}"
          echo "ğŸ³ Image: ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:$TAG"
          echo ""
          if [[ "${{ needs.download-and-push.result }}" == "success" && "${{ needs.deploy.result }}" == "success" ]]; then
            echo "âœ… DÃ©ploiement rÃ©ussi"
            echo "ğŸ¯ URL Production: http://${{ secrets.VPS_HOST }}:8080/"
          else
            echo "âŒ DÃ©ploiement Ã©chouÃ©"
            echo "ğŸ” Build: ${{ needs.download-and-push.result }}"
            echo "ğŸ” Deploy: ${{ needs.deploy.result }}"
            echo "ğŸ“ VÃ©rifiez les logs des Ã©tapes prÃ©cÃ©dentes"
          fi
