name: CD - DÃ©ploiement Continu

on:
  push:
    branches: [docker]

jobs:
  build-and-push:
    name: ğŸ› ï¸ Build & Push Docker image
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set_tag.outputs.tag }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: ğŸ·ï¸ Set Docker image tag
        id: set_tag
        run: |
          if [[ "${GITHUB_REF##*/}" == "production" ]]; then
            echo "tag=production" >> "$GITHUB_OUTPUT"
          else
            echo "tag=docker" >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸ› ï¸ Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:${{ steps.set_tag.outputs.tag }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:${{ steps.set_tag.outputs.tag }}-${{ github.sha }}

  deploy:
    name: ğŸš€ DÃ©ploiement VPS
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”‘ Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: ğŸš€ SSH to VPS and deploy
        run: |
          TAG=${{ needs.build-and-push.outputs.tag }}
          VPS_USER="${{ secrets.VPS_USER }}"
          VPS_HOST="${{ secrets.VPS_HOST }}"
          SSH_KEY="~/.ssh/id_ed25519"
          VPS_PATH="~/hourproject/prod"
          PORT="8080"
          ssh -o StrictHostKeyChecking=no -i $SSH_KEY $VPS_USER@$VPS_HOST << EOF
            mkdir -p $VPS_PATH
            cd $VPS_PATH
            docker stop hourproject-$TAG || true
            docker rm hourproject-$TAG || true
            docker image prune -f
            docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:$TAG
            docker run -d --name hourproject-$TAG --restart unless-stopped -p $PORT:80 -v $VPS_PATH/public:/var/www/public ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:$TAG
            sleep 5
            docker ps | grep hourproject-$TAG
          EOF

      - name: ğŸ¥ Health check
        run: |
          TAG=${{ needs.build-and-push.outputs.tag }}
          VPS_HOST="${{ secrets.VPS_HOST }}"
          PORT="8080"
          sleep 10
          if curl -f -s --max-time 30 http://$VPS_HOST:$PORT/ > /dev/null; then
            echo "âœ… Application accessible et fonctionnelle"
          else
            echo "âš ï¸ Application potentiellement indisponible, vÃ©rifiez manuellement"
            echo "ğŸŒ URL: http://$VPS_HOST:$PORT/"
          fi

  notification:
    name: ğŸ“¢ Notification de dÃ©ploiement
    needs: [build-and-push, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“‹ GÃ©nÃ©rer le rapport de dÃ©ploiement
        run: |
          TAG=${{ needs.build-and-push.outputs.tag }}
          echo "ğŸ“Š RAPPORT DE DÃ‰PLOIEMENT HOURPROJECT"
          echo "======================================"
          echo "ğŸ• Date: $(date)"
          echo "ğŸŒ¿ Branche: ${{ github.ref_name }}"
          echo "ğŸ·ï¸ Tag: $TAG"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Auteur: ${{ github.actor }}"
          echo "ğŸ³ Image: ${{ secrets.DOCKER_HUB_USERNAME }}/hourproject:$TAG"
          echo ""
          if [[ "${{ needs.build-and-push.result }}" == "success" && "${{ needs.deploy.result }}" == "success" ]]; then
            echo "âœ… DÃ©ploiement rÃ©ussi"
            echo "ğŸ¯ URL Production: http://${{ secrets.VPS_HOST }}:8080/"
          else
            echo "âŒ DÃ©ploiement Ã©chouÃ©"
            echo "ğŸ” Build: ${{ needs.build-and-push.result }}"
            echo "ğŸ” Deploy: ${{ needs.deploy.result }}"
            echo "ğŸ“ VÃ©rifiez les logs des Ã©tapes prÃ©cÃ©dentes"
          fi
