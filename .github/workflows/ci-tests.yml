name: CI Tests

on:
    push:
        branches: [docker]
    pull_request:
        branches: [docker]

jobs:
    test:
        runs-on: ubuntu-latest
        environment: test  # ← Ajoutez cette ligne
        services:
            mysql:
                image: mysql:8.0
                env:
                    MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
                    MYSQL_DATABASE: ${{ secrets.DB_DATABASE }}
                    MYSQL_USER: ${{ secrets.DB_USERNAME }}
                    MYSQL_PASSWORD: ${{ secrets.DB_PASSWORD }}
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping --silent" --health-interval=10s --health-timeout=5s --health-retries=3
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.2"
                  extensions: mbstring, intl, pdo_mysql
                  coverage: none

            - name: Install Composer dependencies
              run: composer install --prefer-dist --no-progress --no-suggest

            - name: Wait for MySQL
              run: |
                  for i in {1..30}; do
                    if mysqladmin ping -h127.0.0.1 -u${{ secrets.MYSQL_USER }} -p${{ secrets.MYSQL_PASSWORD }} --silent; then
                      break
                    fi
                    sleep 2
                  done

            - name: Create database
              run: php bin/console doctrine:database:create --env=test

            - name: Run migrations
              run: php bin/console doctrine:migrations:migrate --env=test --no-interaction

            - name: Load fixtures
              run: php bin/console doctrine:fixtures:load --env=test --no-interaction

            - name: Run PHPUnit tests
              run: ./vendor/bin/phpunit --testdox
